<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
  
  <!-- 부트스트랩, lodash, jquery등등 각종 라이브러리가 선언된 조각 -->
<th:block th:replace="~{/common/fragment :: library}"></th:block>

    <meta charset="UTF-8" />
    <title>영상통화</title>
  </head>
  <body>
<th:block th:replace="~{/common/fragment :: header}"></th:block>

    <h3>니가 받은 초대</h3>
    <div id="invitedRoom">
      <button type="button">새로고침</button>
      <!-- 작성하지 않음 -->
    </div>

    <h3>새로운 방 생성하기</h3>
    <form id="createRoomForm" th:action="@{/videoCall/createRoom}" method="get">
      <div>
        <label for="vcName"><b>방 이름</b></label
        ><br />
        <input
          type="text"
          id="vcName"
          placeholder="방 이름"
          name="vcName"
          required
        />
        <div id="vcNameResult"></div>
      </div>
      <div>
        <label for="maxParticipants">최대 참여인원</label>
        <input type="number" id="maxParticipants" name="maxParticipants" />
        <div id="mpResult"></div>
      </div>

      <div id="finalResult"></div>
      <div>
        <button type="submit" id="insertSubmit" disabled>만들기</button>
        <button type="button" id="insertReset">초기화</button>
      </div>
    </form>

    <hr />

    <h3>내가 생성한 방 들어가기</h3>
    <!--
      model의 myVcRoom에 List<VideoCall>로 담김
      videoCall 객체 : 
      public class VideoCall {
			private byte[] vcId;
			private String userNo; //방장 회원번호
			private String vcName;
			private Timestamp createTimestamp;
			private int maxParticipants;
			private String status;
			
			//방장 이름과 시드
			private String userName; //member
			private byte[] nameSeed; //member
			
		}
	해당 객체 리스트로부터 카드 생성. 양식은 아래 참조
	userName을 맨 앞에 작성하고, vcId를 그 뒤에 샾(#)을 붙여 표시함
	그 밑에는 생성 날짜 : createTimestamp, 최대 인원 : maxParticipants,
	status('Y'이면 방송중, 'N'이면 아무런 표시하지 않음) 표시
	
	카드영역 우측 하단에는 '참여하기', '초대하기', '삭제하기' 버튼을 둠.
	버튼은 셋 모두 적절한 부트스트랩 아이콘으로 나타내기
	'참여하기'버튼을 누르고 확인 모달을 거치면, vcId를 가지고 @{/videoCall/recallRoom} 으로 POST 비동기 요청
	'초대하기'버튼을 누르면 vcId를 가지고 @{/videoCall/inviteUser} 으로 GET 요청
	'삭제하기'버튼을 누르고 확인 모달을 거치면, vcId를 가지고 @{/videoCall/deleteRoom} 으로 POST 비동기 요청
	
	'참여하기', '삭제하기'버튼의 응답은 'success'와 'fail'이며, 각각 성공과 실패를 뜻함. 
	
    -->

    <hr />

    <h3>다른 방 참여하기</h3>
    <div id="invitedRoom">
      <form action="@{/videoCall/goInvitedRoom}" method="POST">
        vcId : <input type="text" name="roomHref" /> <br />
      </form>
    </div>

    <!-- 초대 : 다른 사람을 초대할 때는 해당 유저의 userId, 방 vcId를 알아내 보내자-->

    <script th:inline="javascript">
      $(function () {
        //------------------------새로운 방 생성-----------------------

        //모든 검증이 true여야 sumbmit버튼 활성화됨
        let vcNamePass = false;
        let mpPass = false;

        //방 이름 검증
        document
          .getElementById("vcName")
          .addEventListener("input", function () {
            let vcNameResult = document.getElementById("vcNameResult");
            if (this.value.trim().length > 30) {
              vcNameResult.innerHTML = "이름이 너무 길어요";
              vcNamePass = false;
            } else if (this.value.trim().length < 1) {
              vcNameResult.innerHTML = "이름을 입력해 주세요";
              vcNamePass = false;
            } else {
              vcNameResult.innerHTML = "좋아요!";
              vcNamePass = true;
            }
            toggleSubmit();
          });

        //참여인원 수 검증
        document
          .getElementById("maxParticipants")
          .addEventListener("input", function () {
            let mpResult = document.getElementById("mpResult");
            if (this.value <= 0 || this.value > 10) {
              mpResult.innerHTML = "최대 참여인원을 10명 이하로 작성해 주세요.";
              mpPass = false;
            } else {
              mpResult.innerHTML = "좋아요!";
              mpPass = true;
            }
            toggleSubmit();
          });

        document
          .getElementById("insertReset")
          .addEventListener("click", function () {
            if (confirm("진짜?")) {
              document.getElementById("createRoomForm").reset();
              vcNamePass = false;
              mpPass = false;

              document.getElementById("vcNameResult").innerHTML = "";
              document.getElementById("mpResult").innerHTML = "";
              document.getElementById("finalResult").innerHTML = "";
              toggleSubmit();
            }
          });

        let toggolePassed = false;
        function toggleSubmit() {
          let finalResult = document.getElementById("finalResult");
          if (vcNamePass && mpPass) {
            setButtonState("active");
            toggolePassed = true;
          } else if (toggolePassed == true) {
            setButtonState("disabled");
            toggolePassed = false;
          }
        }

        function setButtonState(state) {
          let insertSubmit = document.getElementById("insertSubmit");
          let finalResult = document.getElementById("finalResult");

          switch (state) {
            case "disabled":
              finalResult.innerHTML = "모든 필수 항목을 확인해 주세요";
              insertSubmit.disabled = true;
              break;
            case "active":
              finalResult.innerHTML = "좋아요!";
              insertSubmit.disabled = false;
              break;
          }
        }

        $("#createRoomForm").on("submit", function (e) {
          e.preventDefault();

          let formData = {
            vcName: $("#vcName").val(),
            maxParticipants: $("#maxParticipants").val(),
          };

          $.ajax({
            url: /*[[@{/videoCall/createRoom}]]*/ "새로운 방 만들기",
            method: "POST",
            data: formData,
            success: function (data) {
              if (data == "success") {
                createRoomArea();
              } else {
                alert("방 생성에 실패했습니다.");
              }
            },
            error: function () {
              alert("서버 오류가 발생했습니다.");
            },
          });
        });

        //생성된 방 정보 동적 생성
        function createRoomArea() {
          let userName = '${loginUser.userName}';
          let vcName = '${createdVcRoom.vcId}';
          let createTimestamp = new Date('${createdVcRoom.createTimestamp}')
          	.toLocaleString();
          let vcRoomUrl = data.vcRoomUrl;

          // 동적으로 영역 생성
          let html = `
            <div class="card mt-3" id="createdRoomCard">
              <div class="card-body">
                <h5 class="card-title">${userName} 님의 방 - ${vcName} (${createTimestamp})</h5>
                <a href="${createdVcRoomUrl}" target="_blank" class="btn btn-primary">참여하기</a>
              </div>
            </div>
          `;

          $("#createdRoomCard").remove();
          $("#createRoomForm").after(html);
        }

        //------------------------초대받은 방 참여-------------------
      });
    </script>
  </body>
</html>
