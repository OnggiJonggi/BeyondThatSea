<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>영상통화</title>
    <th:block th:replace="~{/common/fragment :: library}"></th:block>
    <style>
      body,
      html {
        height: 100%;
        background: #f8f9fa;
      }
      .main-container {
        min-height: 90vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .vc-wrapper {
        background: #fff;
        border-radius: 1.5rem;
        box-shadow: 0 0 24px rgba(0, 0, 0, 0.08);
        padding: 2.5rem 2rem;
        max-width: 1200px;
        width: 100%;
        min-height: 800px;
        display: flex;
        gap: 2.5rem;
      }
      .vc-left,
      .vc-right {
        flex: 1 1 0;
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
      }
      .scroll-area {
        max-height: 480px;
        overflow-y: auto;
        padding-right: 8px;
      }
      .vc-card {
        min-width: 320px;
        max-width: 480px;
        margin-bottom: 1.2rem;
      }
      .vc-card .badge-live {
        background: #dc3545;
        color: white;
        font-size: 0.85em;
        margin-left: 0.5em;
      }
      .vc-card .card-footer {
        background: transparent;
        border-top: none;
      }
      .vc-card .btn-icon {
        padding: 0.4em 0.6em;
        font-size: 1.2em;
      }
      .deleted-card {
        background-color: #f8d7da !important;
        color: #721c24 !important;
      }
      /* 스크롤바 꾸미기 */
      .scroll-area::-webkit-scrollbar {
        width: 8px;
        background: #eee;
        border-radius: 4px;
      }
      .scroll-area::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <th:block th:replace="~{/common/fragment :: header}"></th:block>

    <div class="main-container">
      <div class="vc-wrapper">
        <!-- 왼쪽 영역 -->
        <div class="vc-left">
          <!-- 새로운 방 생성 -->
          <section>
            <h3 class="mb-3">
              <i class="bi bi-plus-circle"></i> 새로운 방 생성하기
            </h3>
            <form
              id="createRoomForm"
              th:action="@{/videoCall/createRoom}"
              method="get"
              class="mb-4"
            >
              <div class="mb-3">
                <label for="vcName"><b>방 이름</b></label>
                <input
                  type="text"
                  class="form-control"
                  id="vcName"
                  placeholder="방 이름"
                  name="vcName"
                  required
                />
                <div id="vcNameResult" class="form-text"></div>
              </div>
              <div class="mb-3">
                <label for="maxParticipants">최대 참여인원</label>
                <input
                  type="number"
                  class="form-control"
                  id="maxParticipants"
                  name="maxParticipants"
                  min="1"
                  max="10"
                />
                <div id="mpResult" class="form-text"></div>
              </div>
              <div id="finalResult" class="mb-2"></div>
              <div>
                <button
                  type="submit"
                  id="insertSubmit"
                  class="btn btn-primary"
                  disabled
                >
                  만들기
                </button>
                <button
                  type="button"
                  id="insertReset"
                  class="btn btn-outline-secondary"
                >
                  초기화
                </button>
              </div>
            </form>
            <div id="createdRoomArea"></div>
          </section>
          <!-- 내가 생성한 방 -->
          <section>
            <h3 class="mb-3">
              <i class="bi bi-person-video2"></i> 내가 생성한 방 들어가기
            </h3>
            <div class="scroll-area">
              <div class="row">
                <div class="col-12" th:each="vc : ${myVcRoom}">
                  <div
                    class="card vc-card shadow-sm"
                    th:id="'myRoomCard-' + ${vc.vcIdStr}"
                    th:classappend="${vc.deleted} ? 'deleted-card'"
                  >
                    <div class="card-body" th:if="${!vc.deleted}">
                      <h5 class="card-title">
                        <span th:text="${vc.userName}">방장</span>
                        <span class="text-muted"
                          >#<span th:text="${vc.vcIdStr}">ID</span></span
                        >
                        <span
                          th:if="${vc.status == 'Y'}"
                          class="badge badge-live"
                          >방송중</span
                        >
                      </h5>
                      <div class="mb-2">
                        <small>
                          <i class="bi bi-calendar-event"></i>
                          <span
                            th:text="${#dates.format(vc.createTimestamp, 'yyyy-MM-dd')}"
                            >생성일</span
                          >
                        </small>
                      </div>
                      <div>
                        <small>
                          <i class="bi bi-people"></i>
                          최대 인원:
                          <span th:text="${vc.maxParticipants}">0</span>명
                        </small>
                      </div>
                    </div>
                    <!-- 삭제된 경우 -->
                    <div class="card-body" th:if="${vc.deleted}">
                      <h5 class="card-title">삭제되었습니다</h5>
                    </div>
                    <div
                      class="card-footer d-flex justify-content-end gap-2"
                      th:if="${!vc.deleted}"
                    >
                      <button
                        class="btn btn-primary btn-icon"
                        th:attr="onclick=|recallRoom('${vc.vcIdStr}')|"
                        title="참여하기"
                      >
                        <i class="bi bi-box-arrow-in-right"></i>
                      </button>
                      <button
                        class="btn btn-secondary btn-icon"
                        th:attr="onclick=|inviteUser('${vc.vcIdStr}')|"
                        title="초대하기"
                      >
                        <i class="bi bi-person-plus"></i>
                      </button>
                      <button
                        class="btn btn-outline-danger btn-icon"
                        th:attr="onclick=|deleteRoom('${vc.vcIdStr}')|"
                        title="삭제하기"
                      >
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                    <div
                      class="card-footer d-flex justify-content-end"
                      th:if="${vc.deleted}"
                    >
                      <button
                        class="btn btn-outline-secondary btn-icon"
                        th:attr="onclick=|undoDeleteRoom('${vc.vcIdStr}')|"
                        title="취소하기"
                      >
                        <i class="bi bi-arrow-counterclockwise"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <a class="btn btn-link mt-2" th:href="@{/videoCall/deletedRoom}">
              <i class="bi bi-trash3"></i> 삭제한 방
            </a>
          </section>
        </div>
        <!--세로선-->
        <hr
          class="vc-divider"
          style="
            width: 2px;
            background: #eee;
            border: none;
            margin: 0 1.5rem;
            height: auto;
          "
        />
        <!-- 오른쪽 영역 -->
        <div class="vc-right">
          <!-- 초대받은 방 -->
          <section>
            <h3 class="mb-3">
              <i class="bi bi-envelope-paper"></i> 초대가 왔어요!
            </h3>
            <button
              type="button"
              class="btn btn-outline-secondary mb-3"
              
            >
              <i class="bi bi-arrow-clockwise"></i> 새로고침
            </button>
            <div class="scroll-area">
              <div
                class="row"
                th:if="${invitedRoom != null and invitedRoom.size() > 0}"
              >
                <div class="col-12" th:each="vc : ${invitedRoom}">
                  <div class="card vc-card shadow-sm">
                    <!-- ... 카드 내용 ... -->
                    <div class="card-footer d-flex justify-content-end gap-2">
                      <button
                        class="btn btn-success btn-icon"
                        th:attr="onclick=|inviteRoomAction('${vc.vcIdStr}', true)|"
                        title="참여하기"
                      >
                        <i class="bi bi-person-check"></i>
                      </button>
                      <button
                        class="btn btn-outline-danger btn-icon"
                        th:attr="onclick=|inviteRoomAction('${vc.vcIdStr}', false)|"
                        title="거절하기"
                      >
                        <i class="bi bi-x-circle"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div
                th:if="${invitedRoom == null or invitedRoom.size() == 0}"
                class="text-center text-muted py-5"
              >
                초대장이 오지 않았어요
              </div>
            </div>
          </section>
          <!-- 내가 참여한 방 -->
          <section>
            <h3 class="mb-3">
              <i class="bi bi-people-fill"></i> 참여한 방 들어가기
            </h3>
            <div class="scroll-area">
              <div
                class="row"
                th:if="${allowedRoom != null and allowedRoom.size() > 0}"
              >
                <div class="col-12" th:each="vc : ${allowedRoom}">
                  <div class="card vc-card shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <span th:text="${vc.userName}">방장</span>
                        <span class="text-muted"
                          >#<span th:text="${vc.vcIdStr}">ID</span></span
                        >
                        <span
                          th:if="${vc.status == 'Y'}"
                          class="badge badge-live"
                          >방송중</span
                        >
                      </h5>
                      <div class="mb-2">
                        <small>
                          <i class="bi bi-calendar-event"></i>
                          <span
                            th:text="${#dates.format(vc.createTimestamp, 'yyyy-MM-dd')}"
                            >생성일</span
                          >
                        </small>
                      </div>
                      <div>
                        <small>
                          <i class="bi bi-people"></i>
                          최대 인원:
                          <span th:text="${vc.maxParticipants}">0</span>명
                        </small>
                      </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                      <button
                        class="btn btn-primary btn-icon"
                        th:attr="onclick=|goAllowedRoom('${vc.vcIdStr}')|"
                        title="들어가기"
                      >
                        <i class="bi bi-camera-video"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div
                th:if="${allowedRoom == null or allowedRoom.size() == 0}"
                class="text-center text-muted py-5"
              >
                참여중인 방이 없습니다
              </div>
            </div>
          </section>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      // ----------------------초대받은 방 참여/거절-------------------------
      function inviteRoomAction(vcIdStr, allow) {
        $.post({
          url: /*[[@{/videoCall/invitedRoom}]]*/ "/videoCall/invitedRoom",
          data: { vcIdStr: vcIdStr, allow: allow },
          success: function (data) {
            if (data === "success") {
              location.reload();
            } else {
              alert("처리에 실패했습니다.");
            }
          },
          error: function () {
            alert("서버 오류가 발생했습니다.");
          },
        });
      }

      //------------------------새로운 방 생성-----------------------

      //모든 검증이 true여야 sumbmit버튼 활성화됨
      let vcNamePass = false;
      let mpPass = false;

      //방 이름 검증
      document.getElementById("vcName").addEventListener("input", function () {
        let vcNameResult = document.getElementById("vcNameResult");
        if (this.value.trim().length > 30) {
          vcNameResult.innerHTML = "이름이 너무 길어요";
          vcNamePass = false;
        } else if (this.value.trim().length < 1) {
          vcNameResult.innerHTML = "이름을 입력해 주세요";
          vcNamePass = false;
        } else {
          vcNameResult.innerHTML = "좋아요!";
          vcNamePass = true;
        }
        toggleSubmit();
      });

      //참여인원 수 검증
      document
        .getElementById("maxParticipants")
        .addEventListener("input", function () {
          let mpResult = document.getElementById("mpResult");
          if (this.value <= 0 || this.value > 10) {
            mpResult.innerHTML = "최대 참여인원을 10명 이하로 작성해 주세요.";
            mpPass = false;
          } else {
            mpResult.innerHTML = "좋아요!";
            mpPass = true;
          }
          toggleSubmit();
        });

      document
        .getElementById("insertReset")
        .addEventListener("click", function () {
          if (confirm("진짜?")) {
            document.getElementById("createRoomForm").reset();
            vcNamePass = false;
            mpPass = false;

            document.getElementById("vcNameResult").innerHTML = "";
            document.getElementById("mpResult").innerHTML = "";
            document.getElementById("finalResult").innerHTML = "";
            toggleSubmit();
          }
        });

      let toggolePassed = false;
      function toggleSubmit() {
        let finalResult = document.getElementById("finalResult");
        if (vcNamePass && mpPass) {
          setButtonState("active");
          toggolePassed = true;
        } else if (toggolePassed == true) {
          setButtonState("disabled");
          toggolePassed = false;
        }
      }

      function setButtonState(state) {
        let insertSubmit = document.getElementById("insertSubmit");
        let finalResult = document.getElementById("finalResult");

        switch (state) {
          case "disabled":
            finalResult.innerHTML = "모든 필수 항목을 확인해 주세요";
            insertSubmit.disabled = true;
            break;
          case "active":
            finalResult.innerHTML = "좋아요!";
            insertSubmit.disabled = false;
            break;
        }
      }

      $("#createRoomForm").on("submit", function (e) {
        e.preventDefault();

        let formData = {
          vcName: $("#vcName").val(),
          maxParticipants: $("#maxParticipants").val(),
        };

        $.ajax({
          url: /*[[@{/videoCall/createRoom}]]*/ "새로운 방 만들기",
          method: "POST",
          data: formData,
          success: function (data) {
            if (data == "success") {
              createRoomArea();
            } else {
              alert("방 생성에 실패했습니다.");
            }
          },
          error: function () {
            alert("서버 오류가 발생했습니다.");
          },
        });
      });

      //생성된 방 정보 동적 생성
      function createRoomArea() {
        let userName = "${loginUser.userName}";
        let vcName = "${createdVcRoom.vcIdStr}";
        let createTimestamp = new Date(
          "${createdVcRoom.createTimestamp}"
        ).toLocaleString();
        let vcRoomUrl = "${createdVcRoomUrl}";

        // 동적으로 영역 생성
        let html = `
            <div class="card mt-3" id="createdRoomCard">
              <div class="card-body">
                <h5 class="card-title">${userName} 님의 방 - ${vcName} (${createTimestamp})</h5>
                <a href="${createdVcRoomUrl}" target="_blank" class="btn btn-primary">참여하기</a>
              </div>
            </div>
          `;

        $("#createdRoomCard").remove();
        $("#createRoomForm").after(html);
      }

      // ----------------------내가 생성한 방---------------------------
      // 내가 생성한 방 - 참여하기
      function recallRoom(vcIdStr) {
        if (confirm("참여하시겠습니까?")) {
          $("<form>", {
            method: "POST",
            action: "/videoCall/recallRoom",
          })
            .append(
              $("<input>", {
                type: "hidden",
                name: "vcIdStr",
                value: vcIdStr,
              })
            )
            .appendTo("body")
            .submit();
        }
      }
      // 내가 생성한 방 - 초대하기
      function inviteUser(vcIdStr) {
        window.location.href =
          "/videoCall/inviteUser?vcIdStr=" + encodeURIComponent(vcIdStr);
      }
      // 내가 생성한 방 - 삭제하기
      function deleteRoom(vcIdStr) {
        $.post({
          url: "/videoCall/deleteRoom",
          data: { vcIdStr: vcIdStr },
          success: function (data) {
            if (data === "success") {
              $("#myRoomCard-" + vcIdStr).addClass("deleted-card");
              $("#myRoomCard-" + vcIdStr + " .card-body").html(
                '<h5 class="card-title">삭제되었습니다</h5>'
              );
            } else {
              alert("삭제에 실패했습니다.");
            }
          },
          error: function () {
            alert("서버 오류가 발생했습니다.");
          },
        });
      }
      // 내가 생성한 방 - 삭제 취소
      function undoDeleteRoom(vcIdStr) {
        $.post({
          url: "/videoCall/undoDeleteRoom",
          data: { vcIdStr: vcIdStr },
          success: function (data) {
            if (data === "success") {
              location.reload();
            } else {
              alert("복구에 실패했습니다.");
            }
          },
          error: function () {
            alert("서버 오류가 발생했습니다.");
          },
        });
      }

      // ------------------------참여한 방 들어가기--------------------------
      function goAllowedRoom(vcIdStr) {
        $("<form>", {
          method: "POST",
          action: "/videoCall/goAllowedRoom",
        })
          .append(
            $("<input>", {
              type: "hidden",
              name: "vcIdStr",
              value: vcIdStr,
            })
          )
          .appendTo("body")
          .submit();
      }

      // 초대받은 방 들어가기
      function goToRoom(url) {
        window.open(url, "_blank");
      }
    </script>
  </body>
</html>
