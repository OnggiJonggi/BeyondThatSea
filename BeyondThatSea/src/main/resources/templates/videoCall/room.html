<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
  <head>
    <meta charset="UTF-8" />
    <script src="${pageContext.request.contextPath}/openvidu-webcomponent-2.23.0.js"></script>
    <link
      rel="stylesheet"
      href="${pageContext.request.contextPath}/openvidu-webcomponent-2.23.0.css"
    />
    <th:block th:replace="/common/header :: head"></th:block>
    <title>${vcRoom.UserName}님의 방</title>
  </head>
  <body>
    <th:block th:replace="/common/header :: header"></th:block>

    <!-- 화상 회의 컨테이너 -->
    <div style="width: 100%; height: 80vh">
      <!-- Web Component: 세션 ID와 토큰을 동적으로 설정 -->
      <openvidu-webcomponent
        id="ov-webcomponent"
        session-id="${vcRoom.vcSession}"
      >
      </openvidu-webcomponent>
    </div>

    <!-- 초대 : 다른 사람을 초대할 때는 해당 유저의 userId를 알아내어 vcId와 함께 보내자-->
    <!-- 방에서 나갈 때는 videoCallRoom세션 날려야함 안그럼 큰일남 -->

    <script>
      <!-- 토큰 처리 -->
      document.addEventListener("DOMContentLoaded", async () => {
        const webComponent = document.getElementById("ov-webcomponent");

        //토큰 요청 함수
        const getToken = async (sessionId) => {
          const response = await fetch(
            `${root}/videoCall/participate/\${sessionId}`,
            {
              method: "POST",
            }
          );
          return await response.json();
        };

        try {
          // 서버에서 토큰 생성 요청
          const tokenData = await getToken("${vcRoom.vcSession}");

          // Web Component에 토큰 설정
          webComponent.token = tokenData.token;

          // 연결 성공 이벤트 핸들러
          webComponent.addEventListener("onSessionCreated", (event) => {
            console.log("세션 연결 성공!", event.detail);
          });
        } catch (error) {
          console.error("토큰 오류:", error);
          alert("화상 회의 접속 실패!");
        }
      });
    </script>
  </body>
</html>
